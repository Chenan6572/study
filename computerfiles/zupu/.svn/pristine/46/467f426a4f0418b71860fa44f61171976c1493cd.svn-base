define(function (require) {
	var $ = require("jquery");
	var justep = require("$UI/system/lib/justep");
	var jsonsql = require("$UI/zupu/lib/jsonsql");
	var ispwd = "1";

	var Model = function () {
		this.callParent();

	};

	// 图片路径转换
	Model.prototype.toUrl = function (url) {
		return url ? require.toUrl(url) : "";
	};

	// 页面初始化
	Model.prototype.modelLoad = function (event) {
		console.log("login");
		document.addEventListener("deviceready", onDeviceReady, false);
	}

	function onDeviceReady() {
		// 按钮事件
		document.addEventListener("backbutton", function () {}, false); // 返回键
	}
	//获取验证码
	Model.prototype.btnGetCodeClick = function (event) {
	    console.log("点击获取验证码");
		var sjh = document.getElementById("nameInput").value;
		if (!isPhoneNo(sjh)) {
			justep.Util.hint("手机号格式错误！", {
				type: 'danger'
			});
		} else {
			$.ajax({
				url: 'http://10.10.1.232:8088/YProject/yanz/getCode?login_name=' + sjh,
				processData: false,
				cache: false,
				async: true,
				global: false,
				contentType: "application/json; charset=utf-8",
				datatype: "json",
				type: 'get',
				success: function (res) {
					document.getElementById("passwordInput").value=(res.data);
					justep.Util.hint(res.message, {
						type: 'danger'
					});
				},
				error: function (res) {
					justep.Util.hint("服务器异常，请稍后再试！", {
						type: 'danger'
					});
				}
			});
			return;
		}
	}
	//登录
	Model.prototype.loginBtnClick = function (event) {
		var sjh = document.getElementById("nameInput").value;
		var yzm = document.getElementById("passwordInput").value;
		if (ispwd === "1") {
			// 验证
			if (sjh == "") {
				alert("请输入手机号！");
				return;
			} else if (yzm == "") {
				alert("请输入验证码！");
				return;
			} else if (!isPhoneNo(sjh)) {
				justep.Util.hint("手机号格式错误！", {
					type: 'danger'
				});
			} else $.ajax({
				url: 'http://10.10.1.232:8088/YProject/yanz/regilogin?login_name=' + sjh + '&code=' + yzm,
				processData: false,
				cache: false,
				async: true,
				global: false,
				contentType: "application/json; charset=utf-8",
				datatype: "json",
				type: 'get',
				success: function (res) {
					//200为该用户未绑定身份证
					if(res.state==="200"){
						localStorage.setItem("Token",res.data.token);
						localStorage.setItem("loginName",res.data.login_name);
						justep.Shell.showPage("bind");		
					//300为该用户已绑定过身份证
					}else if (res.state === "300") {
						localStorage.setItem("Token",res.data.token);
						localStorage.setItem("loginName",res.data.login_name);
						justep.Shell.showPage("main");
					}else {
						justep.Util.hint(res.message, {
							type: 'danger'
						});
					}
				},
				error: function (res) {
					justep.Util.hint(res.message, {
						type: 'danger'
					});
				}
			});
		} else {
			// 验证
			if (sjh == "") {
				alert("请输入手机号！");
				return;
			} else if (yzm == "") {
				alert("请输入密码！");
				return;
			} else if (!isPhoneNo(sjh)) {
				justep.Util.hint("手机号格式错误！", {
					type: 'warning'
				});
			} else $.ajax({
				url: 'http://10.10.1.232:8088/YProject/yanz/login?login_name=' + sjh + '&password=' + yzm,
				processData: false,
				cache: false,
				async: true,
				global: false,
				contentType: "application/json; charset=utf-8",
				datatype: "json",
				type: 'get',
				success: function (res) {
					if (res.state === "200") {
						localStorage.setItem("Token",res.data.token);
						localStorage.setItem("loginname",res.data.login_name);
						justep.Shell.showPage("main");
					} else {
						justep.Util.hint(res.message, {
							type: 'warning '
						});
					}
				},
				error: function (res) {	
				}
			});
		}

		return;

	};

	// 验证身份证
	function isCardNo(card) {
		var pattern = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
		return pattern.test(card);
	}
	/* 姓名身份证，手机号提交 */
	function isChinaName(name) {
		var pattern = /^[\u4E00-\u9FA5]{1,6}$/;
		return pattern.test(name);
	}

	// 验证手机号
	function isPhoneNo(phone) {
		var pattern = /^1[34578]\d{9}$/;
		return pattern.test(phone);
	}

	Model.prototype.modelActive = function (event) {
		console.log("loginActive");
		justep.Shell.closeAll();
	};

	// 账号密码登录
	Model.prototype.pwdLogin = function (event) {
		if (ispwd === "1") {
			$("#span5").html("密&nbsp;&nbsp;&nbsp;&nbsp;码:");
			$("#span6").text("忘记密码");
			$("#account").text("手机号登录");
			document.getElementById("passwordInput").setAttribute("placeholder", "请输入密码");
			document.getElementById("passwordInput").setAttribute("type", "password");
			ispwd = "0";
		} else {
			$("#span5").text("验证码:");
			$("#span6").text("获取验证码");
			$("#account").text("账号密码登录");
			document.getElementById("passwordInput").setAttribute("placeholder", "请输入验证码");
			document.getElementById("passwordInput").setAttribute("type", "text");
			ispwd = "1";
		}
	};
	return Model;
});